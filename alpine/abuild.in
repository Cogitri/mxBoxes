#!/bin/sh
die() {
    printf "%s\\n" "$@" >&2
    exit 1
}

run() {
    ssh -p %%PORT%% -tt \
        -o User=alpine \
        -o IdentityFile=~/.ssh/alpine-dev-env \
        -o NoHostAuthenticationForLocalhost=yes \
        -o LogLevel=QUIET \
        localhost "$@"
}

## check running from within an `aports` tree
if [ "${PWD%*/aports/*}" = "$PWD" ]; then
	die "Error: expecting to be run from within an aports tree!" \
		"Could not find '/aports/' in the current path: $PWD"
fi

# Generate new abuild key if not set
cmd='grep -sq "^PACKAGER_PRIVKEY=" /home/alpine/.abuild/abuild.conf || abuild-keygen -n -a'

# Copy keys over, we need this so packages will actually succeed when
# building (because of the signing stage), this is also required to
# install them
cmd="$cmd && sudo cp -v /home/alpine/.abuild/*.rsa.pub /etc/apk/keys"

case "$1" in
    checksum|unpack) cmd="$cmd; cd /home/alpine/aports/${PWD#*/aports/} && abuild $@" ;;
    *) cmd="$cmd && cd /home/alpine/aports/${PWD#*/aports/} && sudo apk upgrade -U -a && abuild $@" ;;
esac

run "$cmd"
