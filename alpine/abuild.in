#!/bin/sh
die() {
    printf "%s\\n" "$*" >&2
    exit 1
}

## check running from within an `aports` tree
if [ "${PWD%*/aports/*}" = "$PWD" ]; then
	die "Error: expecting to be run from within an aports tree!" \
		"Could not find '/aports/' in the current path: $PWD"
fi

# Copy keys over, we need this so packages will actually succeed when
# building (because of the signing stage), this is also required to
# install them
ssh -p %%PORT%% -tt \
    -o User=alpine \
    -o IdentityFile=~/.ssh/alpine-dev-env \
    -o NoHostAuthenticationForLocalhost=yes \
    -o LogLevel=QUIET \
    localhost "sudo cp -v /home/alpine/.abuild/*.rsa.pub /etc/apk/keys"

case "$1" in
    checksum|unpack)
        ssh -p %%PORT%% -tt \
            -o User=alpine \
            -o IdentityFile=~/.ssh/alpine-dev-env \
            -o NoHostAuthenticationForLocalhost=yes \
            -o LogLevel=QUIET \
            localhost "cd /home/alpine/aports/${PWD#*/aports/} && abuild $@"
            ;;
    *)
        ssh -p %%PORT%% -tt \
            -o User=alpine \
            -o IdentityFile=~/.ssh/alpine-dev-env \
            -o NoHostAuthenticationForLocalhost=yes \
            -o LogLevel=QUIET \
            localhost "cd /home/alpine/aports/${PWD#*/aports/} && sudo apk upgrade -U -a && abuild $@"
            ;;
esac
