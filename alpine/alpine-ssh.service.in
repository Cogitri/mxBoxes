[Unit]
Description=Alpine Developer Environment with local SSH Access

[Service]
Type=forking
Restart=always
ExecStartPre=/usr/bin/rm -f %t/%n-pid %t/%n-cid
ExecStart=%%PODMAN%% run \
    --replace \
    --conmon-pidfile %t/%n-pid \
    --cidfile %t/%n-cid \
    --publish %%PORT%%:%%PORT%% \
    --volume %h:%h \
    --security-opt label=disable \
    --userns=keep-id \
    --tty \
    --name alpine-dev-env-for-%u \
    --detach \
    alpine-dev-env
# Add our user to abuild group, we require it to access the distfiless
ExecStartPost=%%PODMAN%% exec \
    alpine-dev-env-for-%u \
    adduser %u abuild
# Allow our user to run sudo without any problems
ExecStartPost=%%PODMAN%% exec \
    alpine-dev-env-for-%u \
    sh -c "echo '%u ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers.d/%u-all-nopasswd"
ExecStop=%%PODMAN%% stop \
    --time 2 \
    --cidfile %t/%n-cid
ExecStopPost=%%PODMAN%% rm \
    --ignore \
    --force \
    --cidfile %t/%n-cid
KillMode=none
PIDFile=%t/%n-pid

[Install]
WantedBy=multi-user.target
